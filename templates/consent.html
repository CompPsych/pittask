<!DOCTYPE html>
<!-- 
  The consent.html displays the text of your IRB-approved
  consent form.  Even if you are not required to provide
  a consent form, it is helpful to use this form to 
  describe what people can do if an error comes up, etc...

-->
<html>
    <head>
        <meta charset="utf-8" />
        <title>Psychology Experiment - Informed Consent Form</title>
        <link rel="stylesheet" href="/static/css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="/static/css/style.css" type="text/css" />
        <link rel="icon" href="/static/favicon.ico" />
        <script src="/static/lib/jquery-min.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/parameters.js" type="text/javascript"></script>
        <script src="/static/lib/underscore-min.js" type="text/javascript"></script>
        <script src="/static/lib/backbone-min.js" type="text/javascript"></script>
        <script src="/static/js/jspsych/jspsych.js" type="text/javascript"></script>
		<script src="/static/js/jspsych/plugins/jspsych-html-keyboard-response.js" type="text/javascript"></script>
        <script type="text/javascript">
            function onexit() {
              self.close(); // no harm, no foul here
            }
        </script>
		<style>
            #container-consent {
                display: flex;
                align-items: center;
                flex-direction: column;
            }
            #consent-text {
                margin-top: 0;
                width: 800px;
                font-size: 100%;
            }

			#google-captcha {
				display: flex;
				justify-content: center;
				align-items: center;
				height: 90vh;
			}
			@media print {
				body * {
					visibility: hidden;
				}
				.legal, .legal * {
					visibility: visible;
				}
				.legal {
					position: absolute;
					left: 0;
					top: 0;
					overflow:visible;
				} 
			}
		</style>
    </head>
    <body>
        <div id="container-consent">
            <div id="google-captcha">
                <div id="captcha"></div>
            </div>
            <div id="consent" class="hidden">
                <h1>We need your consent to proceed</h1>
                <hr />
                <div class="legal well">
                        <p>
                            You are invited to take part in a research study examining reward processing 
                            and decision-making in typical healthy adults. Researchers at the School of Psychology, 
                            University of New South Wales hope to investigate how people learn about reward, 
                            and how this can influence their future behaviour. We aim to examine the way in 
                            which different relationships between actions influence decision-making. 
                            This will allow us to assess how these processes influence reward-seeking in healthy adults.
                        </p>
                        <p>
                            What will the study involve for me?
                        </p>
                        <p>
                            If you agree to participate in this study, you may be asked to undergo the following 
                            procedures: Computer-based tasks that examine how you process and react to various 
                            decision-making scenarios. The computer tasks will ask you to make keyboard responses. 
                            This should take no longer than 60 minutes.
                        </p>

                    <button type="button" class="btn btn-default btn-sm" onClick="window.print();">
                    <span class="glyphicon glyphicon-print"></span> Print a copy of this
                    </button>
                </div>

                <hr />
                <h4>Do you understand and consent to these terms?</h4>
                <br />

                <center>
                    <button type="button" class="btn btn-primary btn-lg" onClick="window.location='/exp?hitId={{ hitid }}&assignmentId={{ assignmentid }}&workerId={{ workerid }}'">
                    <span class="glyphicon glyphicon-ok"></span> I agree 
                    </button>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button type="button" class="btn btn-danger btn-lg" onClick="onexit()">
                    <span class="glyphicon glyphicon-ban-circle"></span> No thanks, I do not want to do this HIT
                    </button>
                </center>

            </div>


            {% if using_sandbox %}
                <form style="width: auto;" id="mturk_form" action="https://workersandbox.mturk.com/mturk/externalSubmit" method="post">
            {% else %}
                <form style="width: auto;" id="mturk_form" action="https://workersandbox.mturk.com/mturk/externalSubmit" method="post">
            {% endif %}
                <input type="hidden" id="assignmentId" name="assignmentId" value="{{ assignmentid }}"> 
                <input type="hidden" id="hitId" name="hitId" value="{{ hitid }}"> 
                <input type="hidden" id="workerId" name="workerId" value="{{ workerid }}"> 
            </form>

        </div>

		<script src="/static/js/psiturk.js" type="text/javascript"></script>
      
        <script type="text/javascript">
			if(re_captcha) {
				var count_down;
				re_captcha_duration =  re_captcha_duration * 1000;
				var verifyCallback = function() {
					return new Promise(function(resolve, reject) {
                        $('#google-captcha').addClass('hidden');
				        $('#consent').removeClass('hidden');
						// response.setHeader("Set-Cookie", "HttpOnly;Secure;SameSite=Strict");
						clearTimeout(count_down);
						resolve();
					}); // end promise
				};
				var recaptchaError = function(error) {
					// console.log(error);
				}
				var onloadCallback = function() {
					grecaptcha.render('captcha', {
					'sitekey' : '6LeVEP4UAAAAAPpj_lo0njFLHkNUdS22vZvzqTkD',
					'callback' : verifyCallback,
					'error-callback': recaptchaError,
					'theme' : 'light'
					});
				};

				count_down = setTimeout(function() {
                    var uniqueId = "{{ uniqueId }}";  // a unique string identifying the worker/task
                    var condition = "{{ condition }}"; // the condition number
                    var counterbalance = "{{ counterbalance }}"; // a number indexing counterbalancing conditions
                    var adServerLoc = "{{ adServerLoc }}"; // the location of your ad (so you can send user back at end of experiment)
                    var mode = "{{ mode }}";
            
                    var psiTurk = new PsiTurk(uniqueId, adServerLoc, mode);
                    
					// $(window).on('beforeunload', function(){
					// 	return 'Your submission is in progress. Please do not close this window.';
					// });
					// $.ajax({
					// 	dataType: "json",
					// 	type: "GET",
					// 	url: "/worker_submitted?uniqueId={{ workerid }}:{{ assignmentid }}",
					// 	success: function (data) {
					// 		$(window).off('beforeunload');
					// 		$( "#mturk_form" ).submit();
					// 	}
                    // });

                    jsPsych.init({
                            timeline: [{
                                stage_name: 'Thanks',
                                type: 'html-keyboard-response',
                                stimulus: close_instruct_text_thanks,
                                trial_latency: close_instruct_latency,
                                trial_duration: null,
                                response_ends_trial: false,
                                event_type: 'text appears',
                                event_raw_details: 'close_instruct_text_thanks',
                                event_converted_details: "'Thank You!' text appears"
                            }],
                            on_finish: function(){
                                psiTurk.saveData({
                                    success: function() { 
                                        psiTurk.completeHIT();
                                    },
                                    error: console.log('error')
                                });
                            }
                        }
                    );
                    
				}, re_captcha_duration);
			} else {
				$('#google-captcha').addClass('hidden');
				$('#consent').removeClass('hidden');
			}
        </script>
        <script>
            if (re_captcha) {

                // Create a script tag
                var script = document.createElement('script');

                // Assign a URL to the script element
                script.src = 'https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit';

                script.async = true;
                script.defer = true;

                // Get the first script tag on the page (we'll insert our new one before it)
                var ref = document.querySelector('script');

                // Insert the new node before the reference node
                ref.parentNode.insertBefore(script, ref);
            }
        </script>
    </body>
</html>

